@model List<MarketAnalystBot.Domain.Entities.OpportunitySignal>

@{
    ViewData["Title"] = "Sinais de Oportunidade";
    var highlightTicker = (ViewContext.HttpContext.Request.Query["ticker"].ToString() ?? string.Empty).ToUpperInvariant();
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Sinais de oportunidade</h1>
        @if (!string.IsNullOrEmpty(highlightTicker))
        {
            <div>
                <span class="badge bg-info text-dark me-2">Procurando: <strong>@highlightTicker</strong></span>
                <a class="btn btn-sm btn-outline-secondary" href='@Url.Action("Index", "Home")'>Limpar</a>
            </div>
        }
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">Nenhum sinal encontrado.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered table-sm align-middle">
                <thead class="thead-light">
                    <tr>
                        <th>Ticker</th>
                        <th>Tipo</th>
                        <th class="d-none d-md-table-cell">Preço Atual</th>
                        <th>RSI</th>
                        <th class="d-none d-md-table-cell">Signal RSI</th>
                        <th>Data</th>
                        <th class="d-none d-lg-table-cell">Motivo</th>
                        <th class="d-none d-md-table-cell">Saída</th>
                        <th class="d-none d-md-table-cell">Preço Saída</th>
                        <th class="d-none d-md-table-cell">Rsi</th>
                        <th class="d-none d-md-table-cell">Rsi Signal</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var isHighlighted = !string.IsNullOrEmpty(highlightTicker) && string.Equals(item.Ticker, highlightTicker, StringComparison.OrdinalIgnoreCase);
                        var tickerLink = Url.Action("Index", "Ticker", new { codTicker = item.Ticker });
                        double? exitPrice = item.ExitSignal?.LastPrice;
                        string percentText = exitPrice.HasValue && item.LastPrice != 0 ? ((((exitPrice.Value - item.LastPrice) / item.LastPrice) * 100)).ToString("N2") : "-";
                        var percentVal = exitPrice.HasValue && item.LastPrice != 0 ? (((exitPrice.Value - item.LastPrice) / item.LastPrice) * 100) : (double?)null;
                        var percentClass = percentVal.HasValue ? (percentVal.Value >= 0 ? "text-success" : "text-danger") : "text-muted";

                        <tr class="clickable-row @(isHighlighted ? "table-primary" : "")" data-href="@tickerLink" tabindex="0">
                            <td><strong>@item.Ticker</strong></td>
                            <td><span class="badge bg-secondary">@item.Type</span></td>
                            <td class="d-none d-md-table-cell">@item.LastPrice.ToString("N2")</td>
                            <td>@item.LastRsi.ToString("N2")</td>
                            <td class="d-none d-md-table-cell">@item.LastRsiSignal.ToString("N2")</td>
                            <td>@item.Date.ToString("dd/MM/yyyy HH:mm")</td>
                            <td class="d-none d-lg-table-cell">@item.Reason</td>
                            <td class="d-none d-md-table-cell">@(item.ExitSignal != null ? item.ExitSignal.Date.ToString("dd/MM/yyyy HH:mm") : "-")</td>
                            <td class="d-none d-md-table-cell">@(exitPrice.HasValue ? exitPrice.Value.ToString("N2") : "-")</td>
                            <td class="d-none d-md-table-cell">@(item.ExitSignal?.LastRsi.ToString("N2") ?? "-")</td>
                            <td class="d-none d-md-table-cell">@(item.ExitSignal?.LastRsiSignal.ToString("N2") ?? "-")</td>
                            <td class="text-end @percentClass">@percentText</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<style>
    .clickable-row { cursor: pointer; }
    .clickable-row:focus { outline: 3px solid rgba(13,110,253,0.25); }
    .table-primary { --bs-table-accent-bg: #cfe2ff; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.clickable-row').forEach(function (row) {
            row.addEventListener('click', function (e) {
                if (e.target.closest('a')) return;
                var href = row.getAttribute('data-href');
                if (href) location.href = href;
            });

            row.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    var href = row.getAttribute('data-href');
                    if (href) location.href = href;
                }
            });
        });

        // Scroll to and focus the first highlighted row if any
        var highlighted = document.querySelector('.clickable-row.table-primary');
        if (highlighted) {
            highlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
            highlighted.focus();
        }
    });
</script>
