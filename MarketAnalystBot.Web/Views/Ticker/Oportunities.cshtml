@model List<MarketAnalystBot.Web.Models.OpportunityAnalysis>

@{
    ViewData["Title"] = "Oportunidades";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">Oportunidades identificadas</h2>
        <small class="text-muted">Total: <strong>@Model?.Count()</strong></small>
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">Nenhuma análise disponível.</div>
    }
    else
    {
        <div class="table-responsive">
            <table id="opportunitiesTable" class="table table-striped table-hover table-sm align-middle">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Score</th>
                        <th>Tipo</th>
                        <th>Último Preço</th>
                        <th>Último RSI</th>
                        <th>Períodos</th>
                        <th>Data</th>
                        <th>Motivo</th>
                        <th>Sinal-Mensal</th>
                        <th>Sinal-Semanal</th>
                        <th>Sinal-Diário</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var a in Model)
                    {
                        // Open TradingView chart with BMFBOVESPA:<ticker>
                        <tr class="clickable-row" data-href="https://www.tradingview.com/chart/J1wJhQMP/?symbol=BMFBOVESPA%3A@(a.CodTicker)" tabindex="0">
                            <td><strong>@a.CodTicker</strong></td>
                            <td><span class="badge bg-primary">@a.Score</span></td>
                            <td>@a.Type</td>
                            <td>@(a.LastPrice?.ToString("N2") ?? "-")</td>
                            <td>@(a.LastRsi?.ToString("N2") ?? "-")</td>
                            <td>@a.PeriodsConfirmed</td>
                            <td>@a.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@a.Reason</td>
                            <td>@a.MonthlySignal?.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>@a.WeeklySignal?.ToString("yyyy-MM-dd HH:mm:ss") </td>
                            <td>@a.DailySignal?.ToString("yyyy-MM-dd HH:mm:ss") </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function () {
        $('#opportunitiesTable').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
            }
        });

        // Open TradingView in a new tab when clicking a row
        document.querySelectorAll('.clickable-row').forEach(function (row) {
            row.addEventListener('click', function (e) {
                if (e.target.closest('a')) return;
                var href = row.getAttribute('data-href');
                if (href) window.open(href, '_blank');
            });
            row.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    var href = row.getAttribute('data-href');
                    if (href) window.open(href, '_blank');
                }
            });
        });
    });
</script>